{% extends "profile_base.html" %}
{% load bootstrap4 %}

{% block profile_content %}
  <div id="billing">

    <div class="wott-card-body inner-profile-tab">
        <form method="POST" action="" id="id_payments_form" class>
            {% csrf_token %}
            <div class="form-group">
                <label class="wott-label" for="id_payment_plan">Payment plan</label>
                <select name="payment_plan" placeholder="" class="form-control form-control wott-form-control wott-rounded-lg wott-rounded-lg" title="" id="id_payment_plan">
                    <option value="1" selected="">Free (1 node limit)</option>
                    <option value="2">Standard</option>
                </select>
            </div>
            <div class="form-group">
                <label class="wott-label" for="id_subscription_status">Subscription status</label>
                <input type="text" name="subscription_status" placeholder="" class="form-control wott-form-control wott-rounded-lg" title="" disabled="" id="id_subscription_status">
            </div>
            <div class="form-group">
                <label class="wott-label" for="id_current_period_ends">Current billing period ends</label>
                <input type="text" name="current_period_ends" placeholder="" class="form-control wott-form-control wott-rounded-lg" title="" disabled="" id="id_current_period_ends">
            </div>
            <div class="form-group">
                <label class="wott-label" for="id_total_sum">Monthly charge</label>
                <div class="wott-dolar-input">
                    <input type="number" name="total_sum" placeholder="" value="0" class="form-control wott-form-control wott-blue wott-rounded-lg" title="" disabled="" id="id_total_sum">
                </div>
            </div>
            <div class="form-group">
                <label class="wott-label" for="id_nodes_number">Paid nodes (In addition to the first free node)</label>
                <input type="number" name="nodes_number" placeholder="" min="1" class="form-control wott-form-control wott-rounded-lg" title="" disabled="" id="id_nodes_number">
            </div>
            <input type="hidden" name="nodes_number_hidden" placeholder="" id="id_nodes_number_hidden">
            <input type="hidden" name="payment_method_id" placeholder="" id="id_payment_method_id">
            <div class="card-form-group form-group d-none">
                <label class="wott-label" for="id_card_element">Credit or debit card</label>
                <div id="id_card_element" class="StripeElement StripeElement--empty form-control wott-form-control wott-payment-card-inner-box">
                    <div class="__PrivateStripeElement" style="margin: 0px !important; padding: 0px !important; border: none !important; display: block !important; background: transparent !important; position: relative !important; opacity: 1 !important;">
                        <iframe frameborder="0" allowtransparency="true" scrolling="no" name="__privateStripeFrame5" allowpaymentrequest="true" src="https://js.stripe.com/v3/elements-inner-card-bc2f035b775981ac56c3f018e0d98bd1.html#style[base][color]=%2332325d&amp;style[base][fontFamily]=%22Helvetica+Neue%22%2C+Helvetica%2C+sans-serif&amp;style[base][fontSmoothing]=antialiased&amp;style[base][fontSize]=16px&amp;style[base][::placeholder][color]=%23aab7c4&amp;style[invalid][color]=%23fa755a&amp;style[invalid][iconColor]=%23fa755a&amp;componentName=card&amp;wait=false&amp;rtl=false&amp;keyMode=test&amp;apiKey=pk_test_380KNHna4diAHvGVsucQ3pel00xbqUaSQf&amp;origin=http%3A%2F%2Flocalhost%3A8000&amp;referrer=http%3A%2F%2Flocalhost%3A8000%2Fuser%2Fprofile%2Fpayment%2F&amp;controllerId=__privateStripeController1" title="Secure payment input frame" style="border: none !important; margin: 0px !important; padding: 0px !important; width: 1px !important; min-width: 100% !important; overflow: hidden !important; display: block !important; user-select: none !important; height: 19.2px;"></iframe><input class="__PrivateStripeElement-input" aria-hidden="true" aria-label=" " autocomplete="false" maxlength="1" style="border: none !important; display: block !important; position: absolute !important; height: 1px !important; top: 0px !important; left: 0px !important; padding: 0px !important; margin: 0px !important; width: 100% !important; opacity: 0 !important; background: transparent !important; pointer-events: none !important; font-size: 16px !important;">
                    </div>
                </div>
                <div id="id_card_errors" role="alert" style="color:#FF5649;"></div>
            </div>

             <!--The code block below is to be used to show error messages from Stripe-->
            <!--Here it's suposed to loop a non_field_error, but it could be changed to messages etc... -->

            {% if form.non_field_errors %}
              <div class="wott-payment-card-box">
                {% for error in form.non_field_errors %}
                    <div class="wott-rounded-lg wott-alert-full mt-3">
                      <h4 class="wott-medium-text">{{ error }}</h4>
                    </div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="form-group mt-4">
              <button type="submit" class="btn wott-btn btn-wott-primary">Submit</button>
            </div>
        </form>
    </div>
  </div>
  <style>
    .StripeElement--complete {
        background-color: #e9f3f5 !important;
    }
  </style>
{% endblock %}

{% block js %}
  {{ block.super }}
  <script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
      let payment_plan_id = $('#id_payment_plan').val();  // Remember initial payment_plan field value.
      let nodes_number = $('#id_nodes_number').val();  // Remember initial nodes_number field value.
      let form = document.getElementById('id_payments_form');
      let errorElement = document.getElementById('id_card_errors');
      let handle_stripe_submission = false;
      let price_per_node = {{ PRICE_PER_NODE }};

      const style = {
          base: {
              color: '#32325d',
              fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
              fontSmoothing: 'antialiased',
              fontSize: '16px',
              '::placeholder': {
                  color: '#aab7c4'
              }
          },
          invalid: {
              color: '#FF5649',
              iconColor: '#FF5649'
          }
      };

      if (payment_plan_id !== '1') {
          $('#id_nodes_number').removeAttr('disabled');
      }

      // Create a Stripe client.
      let stripe = Stripe('{{ STRIPE_PUBLIC_KEY }}');
      // Create an instance of Elements.
      let elements = stripe.elements();
      // Create an instance of the card Element.
      let card = elements.create('card', {style: style});

      // Add an instance of the card Element into the `id_card_element` <div>.
      card.mount('#id_card_element');

      // Handle real-time validation errors from the card Element.
      card.on('change', (event) => {
          if (event.error) {
              errorElement.textContent = event.error.message;
          } else {
              errorElement.textContent = '';
          }
      });

      $('#id_payment_plan').change(function () {
          let new_payment_plan_id = $(this).val();
          if (new_payment_plan_id === '2') {
              $('#id_nodes_number').removeAttr('disabled');
              if ($('#id_nodes_number').val() === '') {
                  $('#id_nodes_number').val(1);
                  $('#id_total_sum').val(price_per_node);
              }
              if (payment_plan_id === '1') {  // Enabled standard plan.
                  $('.card-form-group').removeClass('d-none');  // Unhide card section.
                  handle_stripe_submission = true;
                  $('html, body').animate({ scrollTop: $('#id_card_element').offset().top});
              }
          } else if (new_payment_plan_id === '1') {
              $('.card-form-group').addClass('d-none');  // Hide card section.
              $('#id_nodes_number').val(nodes_number);
              if (nodes_number)
                  $('#id_total_sum').val(nodes_number * price_per_node);
              else
                  $('#id_total_sum').val('0');
              $('#id_nodes_number').attr('disabled', true);
              handle_stripe_submission = false;
          }
      });

      // Update the total sum field value.
      $('#id_nodes_number').change(function () {
          //alert($(this).val());
          $('#id_total_sum').val($(this).val() * price_per_node);
      });

      // Handle form submission.
      $(form).on('submit', (event) => {
          let nodes_number_hidden = $('#id_nodes_number').val();
          if (nodes_number_hidden === '')
              nodes_number_hidden = 1;
          $('#id_nodes_number_hidden').val(nodes_number_hidden);
          if (handle_stripe_submission) {
              event.preventDefault();
              stripe.createPaymentMethod({type: 'card', card: card}).then(function (result) {
                  if (result.error) {
                      // Inform the user if there was an error.
                      errorElement.textContent = result.error.message;
                  } else {
                      // Save Stripe payment id to the hidden field.
                      var hiddenInput = form.elements["payment_method_id"];
                      hiddenInput.setAttribute('value', result.paymentMethod.id);
                      // Submit the form.
                      form.submit();
                  }
              });
          }
      });
  </script>
{% endblock %}